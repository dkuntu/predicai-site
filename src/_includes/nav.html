<a href="#main" class="skip-link">Skip to content</a>

<header class="site-header">
  <div class="container header-inner">
    <a href="/" class="brand" aria-label="Predicai home">
      <img src="/logo.png" alt="Predicai logo" width="26" height="26" loading="eager">
      <span>Predic<span class="brand-accent">ai</span>&trade;</span>
    </a>

    <button
      class="nav-toggle"
      type="button"
      aria-label="Open menu"
      aria-expanded="false"
      aria-controls="siteNav"
    >
      <span class="nav-toggle-icon" aria-hidden="true">☰</span>
      Menu
    </button>

    <nav class="site-nav" id="siteNav" aria-label="Primary navigation">
      <a href="/" data-nav="home">Home</a>
      <a href="/about.html" data-nav="about">About</a>

      <div class="menu" data-menu="academy">
        <button class="menu-btn" type="button" aria-haspopup="true" aria-expanded="false">
          Academy <span class="caret" aria-hidden="true">▾</span>
        </button>
        <div class="menu-panel" role="menu" aria-label="Academy">
          <a href="/academy.html" role="menuitem">Overview</a>
          <a href="/syllabus.html" role="menuitem">Syllabus</a>
          <a href="/capability.html" role="menuitem">Capability Score</a>
          <a href="/standard.html" role="menuitem">The Standard</a>
        </div>
      </div>

      <div class="menu" data-menu="shield">
        <button class="menu-btn" type="button" aria-haspopup="true" aria-expanded="false">
          Shield <span class="caret" aria-hidden="true">▾</span>
        </button>
        <div class="menu-panel" role="menu" aria-label="Shield">
          <a href="/shield.html" role="menuitem">Overview</a>
          <a href="https://tally.so/r/LZzErv" role="menuitem" target="_blank" rel="noopener noreferrer">
            Shield Check (Free)
          </a>
          <a href="/shield-download.html" role="menuitem">Protocols Download</a>
          <a href="/resources.html#safety-zone" role="menuitem">Safety Resources</a>
        </div>
      </div>

      <div class="menu" data-menu="signal">
        <button class="menu-btn" type="button" aria-haspopup="true" aria-expanded="false">
          Signal <span class="caret" aria-hidden="true">▾</span>
        </button>
        <div class="menu-panel" role="menu" aria-label="Signal">
          <a href="/signal.html" role="menuitem">Overview</a>
          <a href="/signal.html#subscribe" role="menuitem">Subscribe</a>
          <a href="/signal-archive.html" role="menuitem">Archive</a>
          <a href="/signal-001-stop-generative-summaries.html" role="menuitem">Issue 001</a>
        </div>
      </div>

      <a href="/resources.html" data-nav="resources">Resources</a>
      <a href="/faq.html" data-nav="faq">FAQ</a>
    </nav>
  </div>
</header>

<script>
  (function () {
    const nav = document.getElementById("siteNav");
    const toggle = document.querySelector(".nav-toggle");
    const menus = Array.from(document.querySelectorAll(".menu"));

    // ---- Active link highlighting (body data-active="...") ----
    const active = document.body.getAttribute("data-active");
    if (active) {
      const topLink = document.querySelector(`.site-nav [data-nav="${active}"]`);
      if (topLink) {
        topLink.classList.add("active");
        topLink.setAttribute("aria-current", "page");
      }

      const activeMenu = document.querySelector(`.site-nav .menu[data-menu="${active}"]`);
      if (activeMenu) {
        const btn = activeMenu.querySelector(".menu-btn");
        if (btn) btn.classList.add("active");
      }
    }

    // ---- Helpers ----
    function closeAllMenus(exceptMenu = null) {
      menus.forEach((m) => {
        if (m !== exceptMenu) {
          m.classList.remove("open");
          const btn = m.querySelector(".menu-btn");
          if (btn) btn.setAttribute("aria-expanded", "false");
        }
      });
    }

    function closeMobileTray() {
      if (!nav || !toggle) return;
      nav.classList.remove("open");
      toggle.setAttribute("aria-expanded", "false");
    }

    // ---- Mobile tray toggle ----
    if (toggle && nav) {
      toggle.addEventListener("click", () => {
        const isOpen = nav.classList.toggle("open");
        toggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
        if (!isOpen) closeAllMenus();
      });
    }

    // ---- Dropdown toggle ----
    menus.forEach((menu) => {
      const btn = menu.querySelector(".menu-btn");
      if (!btn) return;

      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const isOpen = menu.classList.contains("open");
        closeAllMenus(menu);
        menu.classList.toggle("open", !isOpen);
        btn.setAttribute("aria-expanded", (!isOpen).toString());
      });

      menu.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          menu.classList.remove("open");
          btn.setAttribute("aria-expanded", "false");
          btn.focus();
        }
      });
    });

    // ---- Click outside closes everything ----
    document.addEventListener("click", (e) => {
      const insideMenu = e.target.closest(".menu");
      const insideNav = e.target.closest("#siteNav");
      const onToggle = e.target.closest(".nav-toggle");

      if (insideMenu || insideNav || onToggle) return;

      closeAllMenus();
      // close mobile tray if open
      if (nav && nav.classList.contains("open")) closeMobileTray();
    });

    // ---- Escape closes menus and mobile tray ----
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      closeAllMenus();
      if (nav && nav.classList.contains("open")) closeMobileTray();
    });

    // ---- Clicking a link closes menus (and mobile tray) ----
    if (nav) {
      nav.querySelectorAll("a").forEach((a) => {
        a.addEventListener("click", () => {
          closeAllMenus();
          if (nav.classList.contains("open")) closeMobileTray();
        });
      });
    }
  })();
</script>
